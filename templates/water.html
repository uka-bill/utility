<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Utility - Bills Management</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fb;
            color: var(--dark);
        }
        
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .logo span {
            margin-left: 10px;
        }
        
        .nav-tabs {
            display: flex;
            list-style: none;
        }
        
        .nav-tabs li {
            margin: 0 5px;
        }
        
        .nav-tabs a {
            text-decoration: none;
            color: var(--gray);
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-tabs a:hover, .nav-tabs a.active {
            background: var(--primary);
            color: white;
        }
        
        .container {
            margin-top: 90px;
            padding: 20px;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            color: var(--dark);
            font-size: 1.8rem;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .filters {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-label {
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: var(--gray);
        }
        
        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .data-table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }
        
        .data-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f9f9f9;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-school {
            background: #e3f2fd;
            color: var(--info);
        }
        
        .badge-department {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--dark);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }
        
        .account-badge {
            background: var(--info);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .actions-cell {
            display: flex;
            gap: 5px;
        }
        
        .entity-selector {
            display: none;
        }
        
        .search-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .search-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .merged-row {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .child-row {
            background-color: #ffffff;
        }
        
        .child-row td:first-child {
            padding-left: 40px;
        }
        
        .toggle-icon {
            cursor: pointer;
            margin-right: 8px;
            display: inline-block;
            width: 20px;
            text-align: center;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .status-paid {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <span>Utility Bills Management</span>
        </div>
        <ul class="nav-tabs">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/departments">Departments</a></li>
            <li><a href="/schools">Schools</a></li>
            <li><a href="/water" class="active">Water</a></li>
            <li><a href="/electricity">Electricity</a></li>
            <li><a href="/telephone">Telephone</a></li>
            <li><a href="/reports">Reports & Print</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Water Utility Bills</h1>
            <button class="btn btn-primary" id="addBillBtn">Add New Bill</button>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Entity Type</label>
                <select class="filter-select" id="entityTypeFilter">
                    <option value="all">All</option>
                    <option value="school">Schools</option>
                    <option value="department">Departments</option>
                </select>
            </div>
            
            <!-- School Search (initially hidden) -->
            <div class="search-group" id="schoolSearchGroup" style="display: none;">
                <label class="filter-label">Select School</label>
                <select class="search-select" id="schoolSearch">
                    <option value="all">All Schools</option>
                </select>
            </div>
            
            <!-- Department Search (initially hidden) -->
            <div class="search-group" id="departmentSearchGroup" style="display: none;">
                <label class="filter-label">Select Department</label>
                <select class="search-select" id="departmentSearch">
                    <option value="all">All Departments</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Month</label>
                <select class="filter-select" id="monthFilter">
                    <option value="all">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Year</label>
                <select class="filter-select" id="yearFilter">
                    <option value="all">All Years</option>
                    <!-- Years will be populated by JavaScript -->
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Search</label>
                <input type="text" class="filter-input" id="searchFilter" placeholder="Search...">
            </div>
        </div>
        
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Entity</th>
                        <th>Type</th>
                        <th>Account No.</th>
                        <th>Meter No.</th>
                        <th>Consumption (M³)</th>
                        <th>Current Charges</th>
                        <th>Late Charges</th>
                        <th>Unsettled Charges</th>
                        <th>Amount Paid</th>
                        <th>Status</th>
                        <th>Bill Image</th>
                        <th>Bill Period</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="billsTable">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Add/Edit Bill Modal -->
    <div class="modal" id="billModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Water Bill</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <form id="billForm">
                <input type="hidden" id="billId">
                <div class="form-group">
                    <label class="form-label">Entity Type</label>
                    <select class="form-control" id="entityType" required>
                        <option value="">Select Type</option>
                        <option value="school">School</option>
                        <option value="department">Department</option>
                    </select>
                </div>
                
                <!-- School Selector (initially hidden) -->
                <div class="form-group entity-selector" id="schoolSelector">
                    <label class="form-label">Select School</label>
                    <select class="form-control" id="schoolId">
                        <option value="">Select School</option>
                    </select>
                </div>
                
                <!-- Department Selector (initially hidden) -->
                <div class="form-group entity-selector" id="departmentSelector">
                    <label class="form-label">Select Department</label>
                    <select class="form-control" id="departmentId">
                        <option value="">Select Department</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Number</label>
                    <div style="display: flex; gap: 10px;">
                        <select class="form-control" id="accountNumberSelect" style="flex: 1;">
                            <option value="">Select Existing Account</option>
                        </select>
                        <input type="text" class="form-control" id="accountNumber" placeholder="Or enter new account" style="flex: 2;">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Meter Number</label>
                        <input type="text" class="form-control" id="meterNumber" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Consumption (M³)</label>
                        <input type="number" step="0.01" class="form-control" id="consumption" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Current Charges ($)</label>
                        <input type="number" step="0.01" class="form-control" id="currentCharges" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Late Charges ($)</label>
                        <input type="number" step="0.01" class="form-control" id="lateCharges" value="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Unsettled Charges ($)</label>
                        <input type="number" step="0.01" class="form-control" id="unsettledCharges" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Amount Paid ($)</label>
                        <input type="number" step="0.01" class="form-control" id="amountPaid" value="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bill Image (Proof)</label>
                        <input type="file" class="form-control" id="billImage" accept="image/*,.pdf">
                        <div id="imagePreview"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bill Month</label>
                        <select class="form-control" id="billMonth" required>
                            <option value="">Select Bill Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Bill Year</label>
                        <input type="number" class="form-control" id="billYear" min="2000" max="2050" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Month (for filtering)</label>
                        <select class="form-control" id="month" required>
                            <option value="">Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Year (for filtering)</label>
                        <input type="number" class="form-control" id="year" min="2000" max="2050" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Bill</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Store bills globally for editing
        let allBills = [];
        let currentYear = new Date().getFullYear();

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        function initializePage() {
            // Populate years from 2000 to 2050
            const yearFilter = document.getElementById('yearFilter');
            for (let year = 2000; year <= 2050; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearFilter.appendChild(option);
            }

            // Load schools and departments for search dropdowns
            loadSchoolsForSearch();
            loadDepartmentsForSearch();

            // Modal functionality
            const addBillBtn = document.getElementById('addBillBtn');
            const billModal = document.getElementById('billModal');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const billForm = document.getElementById('billForm');
            const entityType = document.getElementById('entityType');
            const schoolSelector = document.getElementById('schoolSelector');
            const departmentSelector = document.getElementById('departmentSelector');
            const schoolId = document.getElementById('schoolId');
            const departmentId = document.getElementById('departmentId');
            const modalTitle = document.getElementById('modalTitle');
            const billIdField = document.getElementById('billId');
            const accountNumberSelect = document.getElementById('accountNumberSelect');
            const accountNumber = document.getElementById('accountNumber');
            
            let editingBill = null;

            addBillBtn.addEventListener('click', () => {
                editingBill = null;
                modalTitle.textContent = 'Add Water Bill';
                billForm.reset();
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('billYear').value = currentYear;
                document.getElementById('year').value = currentYear;
                
                // Enable all fields when adding new bill
                document.getElementById('entityType').disabled = false;
                document.getElementById('schoolId').disabled = false;
                document.getElementById('departmentId').disabled = false;
                document.getElementById('accountNumberSelect').disabled = false;
                document.getElementById('accountNumber').disabled = false;
                
                billModal.style.display = 'flex';
            });
            
            closeModal.addEventListener('click', () => {
                billModal.style.display = 'none';
            });
            
            cancelBtn.addEventListener('click', () => {
                billModal.style.display = 'none';
            });
            
            // Load entities when entity type changes
            entityType.addEventListener('change', () => {
                const type = entityType.value;
                
                // Hide both selectors initially
                schoolSelector.style.display = 'none';
                departmentSelector.style.display = 'none';
                
                if (type === 'school') {
                    schoolSelector.style.display = 'block';
                    // Load schools
                    fetch(`/api/entities?type=school`)
                        .then(response => response.json())
                        .then(data => {
                            schoolId.innerHTML = '<option value="">Select School</option>';
                            data.forEach(school => {
                                const option = document.createElement('option');
                                option.value = school.id;
                                option.textContent = school.name;
                                schoolId.appendChild(option);
                            });
                        })
                        .catch(error => {
                            console.error('Error loading schools:', error);
                        });
                } else if (type === 'department') {
                    departmentSelector.style.display = 'block';
                    // Load departments
                    fetch(`/api/entities?type=department`)
                        .then(response => response.json())
                        .then(data => {
                            departmentId.innerHTML = '<option value="">Select Department</option>';
                            data.forEach(department => {
                                const option = document.createElement('option');
                                option.value = department.id;
                                option.textContent = department.name;
                                departmentId.appendChild(option);
                            });
                        })
                        .catch(error => {
                            console.error('Error loading departments:', error);
                        });
                }
            });

            // Load accounts when school or department changes
            schoolId.addEventListener('change', loadAccounts);
            departmentId.addEventListener('change', loadAccounts);
            
            function loadAccounts() {
                const entityTypeVal = entityType.value;
                let entityIdVal = '';
                
                if (entityTypeVal === 'school') {
                    entityIdVal = schoolId.value;
                } else if (entityTypeVal === 'department') {
                    entityIdVal = departmentId.value;
                }
                
                if (entityTypeVal && entityIdVal) {
                    fetch(`/api/entity-accounts?entity_type=${entityTypeVal}&entity_id=${entityIdVal}&utility_type=water`)
                        .then(response => response.json())
                        .then(data => {
                            accountNumberSelect.innerHTML = '<option value="">Select Existing Account</option>';
                            data.forEach(account => {
                                const option = document.createElement('option');
                                option.value = account;
                                option.textContent = account;
                                accountNumberSelect.appendChild(option);
                            });
                        })
                        .catch(error => {
                            console.error('Error loading accounts:', error);
                            accountNumberSelect.innerHTML = '<option value="">Select Existing Account</option>';
                        });
                } else {
                    accountNumberSelect.innerHTML = '<option value="">Select Existing Account</option>';
                }
            }

            // When account is selected from dropdown, populate the input
            accountNumberSelect.addEventListener('change', () => {
                if (accountNumberSelect.value) {
                    accountNumber.value = accountNumberSelect.value;
                }
            });
            
            // Image preview
            document.getElementById('billImage').addEventListener('change', function() {
                const file = this.files[0];
                const preview = document.getElementById('imagePreview');
                
                if (file) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="Bill preview">`;
                        }
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        preview.innerHTML = '<div class="image-preview">PDF File: ' + file.name + '</div>';
                    }
                } else {
                    preview.innerHTML = '';
                }
            });
            
            // Form submission
            billForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const formData = new FormData();
                const imageFile = document.getElementById('billImage').files[0];
                
                if (imageFile) {
                    formData.append('file', imageFile);
                    
                    // Upload image first
                    fetch('/api/upload-bill-image', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.image_url) {
                            saveBillData(data.image_url);
                        } else {
                            alert('Error uploading image: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error uploading image. Please try again.');
                    });
                } else {
                    // If editing and no new image, use existing image URL
                    const imageUrl = editingBill ? editingBill.bill_image : null;
                    saveBillData(imageUrl);
                }
            });
            
            function saveBillData(imageUrl) {
                const entityTypeVal = entityType.value;
                let entityIdVal = '';
                
                if (entityTypeVal === 'school') {
                    entityIdVal = schoolId.value;
                } else if (entityTypeVal === 'department') {
                    entityIdVal = departmentId.value;
                }
                
                if (!entityIdVal) {
                    alert('Please select a school or department');
                    return;
                }
                
                const billData = {
                    utility_type: 'water',
                    entity_type: entityTypeVal,
                    entity_id: parseInt(entityIdVal),
                    account_number: accountNumber.value,
                    meter_number: document.getElementById('meterNumber').value,
                    current_charges: parseFloat(document.getElementById('currentCharges').value),
                    late_charges: parseFloat(document.getElementById('lateCharges').value),
                    unsettled_charges: parseFloat(document.getElementById('unsettledCharges').value),
                    amount_paid: parseFloat(document.getElementById('amountPaid').value),
                    consumption_m3: parseFloat(document.getElementById('consumption').value),
                    month: parseInt(document.getElementById('month').value),  // For filtering
                    year: parseInt(document.getElementById('year').value),    // For filtering
                    bill_month: parseInt(document.getElementById('billMonth').value),  // Actual bill month
                    bill_year: parseInt(document.getElementById('billYear').value),    // Actual bill year
                    bill_image: imageUrl
                };
                
                let url = '/api/utility-bills';
                let method = 'POST';
                
                if (editingBill) {
                    billData.id = editingBill.id;
                    method = 'PUT';
                }
                
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(billData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        billModal.style.display = 'none';
                        billForm.reset();
                        loadBills();
                    } else {
                        alert('Error saving bill: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving bill. Please try again.');
                });
            }
            
            // Filter event listeners
            document.getElementById('entityTypeFilter').addEventListener('change', function() {
                const entityType = this.value;
                const schoolSearchGroup = document.getElementById('schoolSearchGroup');
                const departmentSearchGroup = document.getElementById('departmentSearchGroup');
                
                // Hide both search groups initially
                schoolSearchGroup.style.display = 'none';
                departmentSearchGroup.style.display = 'none';
                
                if (entityType === 'school') {
                    schoolSearchGroup.style.display = 'block';
                } else if (entityType === 'department') {
                    departmentSearchGroup.style.display = 'block';
                }
                
                loadBills();
            });
            
            document.getElementById('schoolSearch').addEventListener('change', loadBills);
            document.getElementById('departmentSearch').addEventListener('change', loadBills);
            document.getElementById('monthFilter').addEventListener('change', loadBills);
            document.getElementById('yearFilter').addEventListener('change', loadBills);
            document.getElementById('searchFilter').addEventListener('input', loadBills);
            
            // Initial load
            loadBills();
        }
        
        function loadSchoolsForSearch() {
            fetch('/api/entities?type=school')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch schools');
                    }
                    return response.json();
                })
                .then(data => {
                    const schoolSearch = document.getElementById('schoolSearch');
                    schoolSearch.innerHTML = '<option value="all">All Schools</option>';
                    
                    if (data && data.length > 0) {
                        data.forEach(school => {
                            const option = document.createElement('option');
                            option.value = school.id;
                            option.textContent = school.name;
                            schoolSearch.appendChild(option);
                        });
                        console.log(`Loaded ${data.length} schools for search`);
                    } else {
                        console.warn('No schools found for search dropdown');
                    }
                })
                .catch(error => {
                    console.error('Error loading schools for search:', error);
                    // Try alternative API endpoint
                    fetch('/api/schools')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch schools from alternative endpoint');
                            }
                            return response.json();
                        })
                        .then(data => {
                            const schoolSearch = document.getElementById('schoolSearch');
                            schoolSearch.innerHTML = '<option value="all">All Schools</option>';
                            
                            if (data && data.length > 0) {
                                data.forEach(school => {
                                    const option = document.createElement('option');
                                    option.value = school.id;
                                    option.textContent = school.name;
                                    schoolSearch.appendChild(option);
                                });
                                console.log(`Loaded ${data.length} schools for search from alternative endpoint`);
                            }
                        })
                        .catch(altError => {
                            console.error('Error loading schools from alternative endpoint:', altError);
                        });
                });
        }
        
        function loadDepartmentsForSearch() {
            fetch('/api/entities?type=department')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch departments');
                    }
                    return response.json();
                })
                .then(data => {
                    const departmentSearch = document.getElementById('departmentSearch');
                    departmentSearch.innerHTML = '<option value="all">All Departments</option>';
                    
                    if (data && data.length > 0) {
                        data.forEach(department => {
                            const option = document.createElement('option');
                            option.value = department.id;
                            option.textContent = department.name;
                            departmentSearch.appendChild(option);
                        });
                        console.log(`Loaded ${data.length} departments for search`);
                    } else {
                        console.warn('No departments found for search dropdown');
                    }
                })
                .catch(error => {
                    console.error('Error loading departments for search:', error);
                    // Try alternative API endpoint
                    fetch('/api/departments')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch departments from alternative endpoint');
                            }
                            return response.json();
                        })
                        .then(data => {
                            const departmentSearch = document.getElementById('departmentSearch');
                            departmentSearch.innerHTML = '<option value="all">All Departments</option>';
                            
                            if (data && data.length > 0) {
                                data.forEach(department => {
                                    const option = document.createElement('option');
                                    option.value = department.id;
                                    option.textContent = department.name;
                                    departmentSearch.appendChild(option);
                                });
                                console.log(`Loaded ${data.length} departments for search from alternative endpoint`);
                            }
                        })
                        .catch(altError => {
                            console.error('Error loading departments from alternative endpoint:', altError);
                        });
                });
        }
        
        // Load bills on page load
        function loadBills() {
            const entityTypeFilter = document.getElementById('entityTypeFilter').value;
            const schoolSearch = document.getElementById('schoolSearch').value;
            const departmentSearch = document.getElementById('departmentSearch').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            let url = '/api/utility-bills?utility_type=water';
            
            // Add entity type filter to API call
            if (entityTypeFilter !== 'all') {
                url += `&entity_type=${entityTypeFilter}`;
            }
            
            // Add specific entity filter to API call
            if (entityTypeFilter === 'school' && schoolSearch !== 'all') {
                url += `&entity_id=${schoolSearch}`;
            } else if (entityTypeFilter === 'department' && departmentSearch !== 'all') {
                url += `&entity_id=${departmentSearch}`;
            }
            
            // Add month and year filters to API call
            if (monthFilter !== 'all') {
                url += `&month=${monthFilter}`;
            }
            if (yearFilter !== 'all') {
                url += `&year=${yearFilter}`;
            }
            
            console.log('Loading bills with URL:', url);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch bills');
                    }
                    return response.json();
                })
                .then(data => {
                    allBills = data; // Store bills for editing
                    
                    // Apply search filter if provided
                    if (searchFilter) {
                        data = data.filter(bill => 
                            bill.entity_name.toLowerCase().includes(searchFilter) ||
                            bill.account_number.toLowerCase().includes(searchFilter) ||
                            bill.meter_number.toLowerCase().includes(searchFilter)
                        );
                    }
                    
                    console.log(`Loaded ${data.length} bills`);
                    renderBillsTable(data);
                })
                .catch(error => {
                    console.error('Error loading bills:', error);
                    alert('Error loading bills. Please try again.');
                });
        }
        
        function renderBillsTable(bills) {
            const tableBody = document.getElementById('billsTable');
            tableBody.innerHTML = '';
            
            if (bills.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="13" style="text-align: center; padding: 30px;">
                            No water bills found matching your criteria. Try adjusting your filters or click "Add New Bill" to create one.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Get the selected school/department name for display
            const entityTypeFilter = document.getElementById('entityTypeFilter').value;
            const schoolSearch = document.getElementById('schoolSearch');
            const departmentSearch = document.getElementById('departmentSearch');
            
            let selectedEntityName = '';
            if (entityTypeFilter === 'school' && schoolSearch.value !== 'all') {
                selectedEntityName = schoolSearch.options[schoolSearch.selectedIndex].text;
            } else if (entityTypeFilter === 'department' && departmentSearch.value !== 'all') {
                selectedEntityName = departmentSearch.options[departmentSearch.selectedIndex].text;
            }
            
            // If a specific entity is selected, only show bills for that entity
            let filteredBills = bills;
            if (selectedEntityName) {
                filteredBills = bills.filter(bill => bill.entity_name === selectedEntityName);
            }
            
            // Group bills by entity name for better organization
            const groupedBills = {};
            filteredBills.forEach(bill => {
                if (!groupedBills[bill.entity_name]) {
                    groupedBills[bill.entity_name] = [];
                }
                groupedBills[bill.entity_name].push(bill);
            });
            
            // Render each entity group
            Object.keys(groupedBills).forEach(entityName => {
                const entityBills = groupedBills[entityName];
                const entityType = entityBills[0].entity_type;
                
                // Create header row for the entity
                const headerRow = document.createElement('tr');
                headerRow.className = 'merged-row';
                headerRow.innerHTML = `
                    <td colspan="13">
                        <span class="toggle-icon" data-entity="${entityName}">▶</span>
                        <strong>${entityName}</strong> 
                        <span class="badge ${entityType === 'school' ? 'badge-school' : 'badge-department'}" style="margin-left: 10px;">
                            ${entityType}
                        </span>
                        <span style="margin-left: 10px; color: #666; font-size: 0.9em;">
                            (${entityBills.length} bill${entityBills.length > 1 ? 's' : ''})
                        </span>
                    </td>
                `;
                tableBody.appendChild(headerRow);
                
                // Create child rows for each bill in the entity
                entityBills.forEach(bill => {
                    const childRow = document.createElement('tr');
                    childRow.className = 'child-row';
                    childRow.style.display = 'none';
                    childRow.setAttribute('data-entity', entityName);
                    
                    // Calculate status
                    const totalCharges = bill.current_charges + bill.late_charges + bill.unsettled_charges;
                    let status = 'pending';
                    let statusText = 'Pending';
                    
                    if (bill.amount_paid >= totalCharges) {
                        status = 'paid';
                        statusText = 'Paid';
                    } else if (bill.late_charges > 0) {
                        status = 'overdue';
                        statusText = 'Overdue';
                    }
                    
                    let imageCell = '-';
                    if (bill.bill_image) {
                        imageCell = `<a href="${bill.bill_image}" target="_blank">View Bill</a>`;
                    }
                    
                    // Use bill_month and bill_year for display instead of month and year
                    const displayMonth = bill.bill_month || bill.month;
                    const displayYear = bill.bill_year || bill.year;
                    
                    childRow.innerHTML = `
                        <td>${bill.entity_name}</td>
                        <td><span class="badge ${bill.entity_type === 'school' ? 'badge-school' : 'badge-department'}">${bill.entity_type}</span></td>
                        <td>${bill.account_number}</td>
                        <td>${bill.meter_number}</td>
                        <td>${bill.consumption_m3}</td>
                        <td>$${bill.current_charges.toFixed(2)}</td>
                        <td>$${bill.late_charges.toFixed(2)}</td>
                        <td>$${bill.unsettled_charges.toFixed(2)}</td>
                        <td>$${(bill.amount_paid || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${status}">${statusText}</span></td>
                        <td>${imageCell}</td>
                        <td>${getMonthName(displayMonth)} ${displayYear}</td>
                        <td class="actions-cell">
                            <button class="btn btn-warning btn-sm edit-btn" data-id="${bill.id}">Edit</button>
                            <button class="btn btn-danger btn-sm delete-btn" data-id="${bill.id}">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(childRow);
                });
            });
            
            // Add event listeners to toggle icons
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    const entityName = this.getAttribute('data-entity');
                    const childRows = document.querySelectorAll(`tr.child-row[data-entity="${entityName}"]`);
                    const isExpanded = childRows[0].style.display !== 'none';
                    
                    if (isExpanded) {
                        // Collapse
                        childRows.forEach(row => row.style.display = 'none');
                        this.textContent = '▶';
                    } else {
                        // Expand
                        childRows.forEach(row => row.style.display = '');
                        this.textContent = '▼';
                    }
                });
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const billId = this.getAttribute('data-id');
                    editBill(billId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const billId = this.getAttribute('data-id');
                    deleteBill(billId);
                });
            });
        }
        
        function editBill(billId) {
            // Find the bill in our stored data
            const bill = allBills.find(b => b.id == billId);
            
            if (!bill) {
                alert('Bill not found in local data. Please refresh the page and try again.');
                return;
            }
            
            editingBill = bill;
            document.getElementById('modalTitle').textContent = 'Edit Water Bill';
            document.getElementById('billId').value = bill.id;
            
            // Set current year as default
            document.getElementById('billYear').value = currentYear;
            document.getElementById('year').value = currentYear;
            
            // Enable account fields when editing
            document.getElementById('entityType').disabled = true;
            document.getElementById('schoolId').disabled = true;
            document.getElementById('departmentId').disabled = true;
            document.getElementById('accountNumberSelect').disabled = false;
            document.getElementById('accountNumber').disabled = false;
            
            // First, set the entity type and wait for it to process
            const entityType = document.getElementById('entityType');
            entityType.value = bill.entity_type;
            
            // Trigger change event to show appropriate selector
            const event = new Event('change');
            entityType.dispatchEvent(event);
            
            // Now load entities for the selected type
            if (bill.entity_type === 'school') {
                fetch(`/api/entities?type=school`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch schools');
                        }
                        return response.json();
                    })
                    .then(schools => {
                        const schoolId = document.getElementById('schoolId');
                        schoolId.innerHTML = '<option value="">Select School</option>';
                        schools.forEach(school => {
                            const option = document.createElement('option');
                            option.value = school.id;
                            option.textContent = school.name;
                            if (school.id == bill.entity_id) {
                                option.selected = true;
                            }
                            schoolId.appendChild(option);
                        });
                        
                        // Now load accounts for this entity
                        return fetch(`/api/entity-accounts?entity_type=school&entity_id=${bill.entity_id}&utility_type=water`);
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch accounts');
                        }
                        return response.json();
                    })
                    .then(accounts => {
                        const accountNumberSelect = document.getElementById('accountNumberSelect');
                        accountNumberSelect.innerHTML = '<option value="">Select Existing Account</option>';
                        accounts.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account;
                            option.textContent = account;
                            accountNumberSelect.appendChild(option);
                        });
                        
                        // Now populate all form fields
                        populateFormFields(bill);
                    })
                    .catch(error => {
                        console.error('Error loading bill data:', error);
                        alert('Error loading bill data. Please try again.');
                    });
            } else {
                fetch(`/api/entities?type=department`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch departments');
                        }
                        return response.json();
                    })
                    .then(departments => {
                        const departmentId = document.getElementById('departmentId');
                        departmentId.innerHTML = '<option value="">Select Department</option>';
                        departments.forEach(department => {
                            const option = document.createElement('option');
                            option.value = department.id;
                            option.textContent = department.name;
                            if (department.id == bill.entity_id) {
                                option.selected = true;
                            }
                            departmentId.appendChild(option);
                        });
                        
                        // Now load accounts for this entity
                        return fetch(`/api/entity-accounts?entity_type=department&entity_id=${bill.entity_id}&utility_type=water`);
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch accounts');
                        }
                        return response.json();
                    })
                    .then(accounts => {
                        const accountNumberSelect = document.getElementById('accountNumberSelect');
                        accountNumberSelect.innerHTML = '<option value="">Select Existing Account</option>';
                        accounts.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account;
                            option.textContent = account;
                            accountNumberSelect.appendChild(option);
                        });
                        
                        // Now populate all form fields
                        populateFormFields(bill);
                    })
                    .catch(error => {
                        console.error('Error loading bill data:', error);
                        alert('Error loading bill data. Please try again.');
                    });
            }
        }
        
        function populateFormFields(bill) {
            document.getElementById('accountNumber').value = bill.account_number || '';
            document.getElementById('meterNumber').value = bill.meter_number || '';
            document.getElementById('consumption').value = bill.consumption_m3 || '';
            document.getElementById('currentCharges').value = bill.current_charges || 0;
            document.getElementById('lateCharges').value = bill.late_charges || 0;
            document.getElementById('unsettledCharges').value = bill.unsettled_charges || 0;
            document.getElementById('amountPaid').value = bill.amount_paid || 0;
            document.getElementById('month').value = bill.month || '';
            document.getElementById('year').value = bill.year || currentYear;
            document.getElementById('billMonth').value = bill.bill_month || bill.month || '';
            document.getElementById('billYear').value = bill.bill_year || bill.year || currentYear;
            
            // Show existing image
            if (bill.bill_image) {
                document.getElementById('imagePreview').innerHTML = `<a href="${bill.bill_image}" target="_blank">View Current Bill Image</a>`;
            } else {
                document.getElementById('imagePreview').innerHTML = '';
            }
            
            document.getElementById('billModal').style.display = 'flex';
        }
        
        function deleteBill(billId) {
            if (confirm('Are you sure you want to delete this bill?')) {
                fetch(`/api/utility-bills?id=${billId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        loadBills();
                    } else {
                        alert('Error deleting bill: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting bill. Please try again.');
                });
            }
        }
        
        function getMonthName(month) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[month - 1] || 'Unknown';
        }
    </script>
</body>
</html>
