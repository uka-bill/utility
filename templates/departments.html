<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Departments - Utility Bills Management</title>
    <style>
        /* ... (keep all existing styles) ... */
        
        /* Add loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
        }
        
        .toast.error {
            background: var(--danger);
        }
    </style>
</head>
<body>
    <!-- ... (keep all existing HTML structure) ... -->

    <!-- Add toast notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Store departments globally for editing
        let allDepartments = [];
        let editingDepartment = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        function initializePage() {
            // Modal functionality
            const addDepartmentBtn = document.getElementById('addDepartmentBtn');
            const departmentModal = document.getElementById('departmentModal');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const departmentForm = document.getElementById('departmentForm');
            const modalTitle = document.getElementById('modalTitle');
            
            addDepartmentBtn.addEventListener('click', () => {
                editingDepartment = null;
                modalTitle.textContent = 'Add Department';
                departmentForm.reset();
                departmentModal.style.display = 'flex';
            });
            
            closeModal.addEventListener('click', () => {
                departmentModal.style.display = 'none';
            });
            
            cancelBtn.addEventListener('click', () => {
                departmentModal.style.display = 'none';
            });
            
            // Form submission
            departmentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveDepartment();
            });
            
            // Initial load
            loadDepartments();
        }
        
        // Show toast message
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Load departments
        function loadDepartments() {
            console.log('Loading departments...');
            fetch('/api/departments')
                .then(response => {
                    console.log('Departments response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to fetch departments');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Departments data received:', data);
                    allDepartments = data;
                    renderDepartmentsTable(data);
                })
                .catch(error => {
                    console.error('Error loading departments:', error);
                    showToast('Error loading departments. Please try again.', true);
                });
        }
        
        function renderDepartmentsTable(departments) {
            const tableBody = document.getElementById('departmentsTable');
            tableBody.innerHTML = '';
            
            if (departments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h3>No Departments Found</h3>
                            <p>Click "Add New Department" to create your first department.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            departments.forEach(department => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${department.id}</td>
                    <td>${department.unit_name || '-'}</td>
                    <td>${department.division_name || '-'}</td>
                    <td>${department.department_name || '-'}</td>
                    <td>${department.hotline_numbers || '-'}</td>
                    <td>${department.address || '-'}</td>
                    <td>${department.notes || '-'}</td>
                    <td class="actions-cell">
                        <button class="btn btn-warning btn-sm edit-btn" data-id="${department.id}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${department.id}">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const departmentId = this.getAttribute('data-id');
                    editDepartment(departmentId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const departmentId = this.getAttribute('data-id');
                    deleteDepartment(departmentId);
                });
            });
        }
        
        function editDepartment(departmentId) {
            const department = allDepartments.find(d => d.id == departmentId);
            
            if (!department) {
                showToast('Department not found in local data. Please refresh the page and try again.', true);
                return;
            }
            
            editingDepartment = department;
            document.getElementById('modalTitle').textContent = 'Edit Department';
            document.getElementById('departmentId').value = department.id;
            document.getElementById('unitName').value = department.unit_name || '';
            document.getElementById('divisionName').value = department.division_name || '';
            document.getElementById('departmentName').value = department.department_name || '';
            document.getElementById('hotlineNumbers').value = department.hotline_numbers || '';
            document.getElementById('departmentAddress').value = department.address || '';
            document.getElementById('notes').value = department.notes || '';
            
            document.getElementById('departmentModal').style.display = 'flex';
        }
        
        function saveDepartment() {
            // Get form values
            const unitName = document.getElementById('unitName').value.trim();
            const divisionName = document.getElementById('divisionName').value.trim();
            const departmentName = document.getElementById('departmentName').value.trim();
            const hotlineNumbers = document.getElementById('hotlineNumbers').value.trim();
            const address = document.getElementById('departmentAddress').value.trim();
            const notes = document.getElementById('notes').value.trim();
            
            // Validate required fields
            if (!unitName) {
                showToast('Please enter a unit name', true);
                return;
            }
            
            if (!divisionName) {
                showToast('Please enter a division name', true);
                return;
            }
            
            if (!departmentName) {
                showToast('Please enter a department name', true);
                return;
            }
            
            const departmentData = {
                unitName: unitName,
                divisionName: divisionName,
                departmentName: departmentName,
                hotlineNumbers: hotlineNumbers,
                address: address,
                notes: notes
            };
            
            let url = '/api/departments';
            let method = 'POST';
            
            if (editingDepartment) {
                departmentData.id = editingDepartment.id;
                method = 'PUT';
            }
            
            // Show loading state
            const saveButton = document.querySelector('#departmentForm button[type="submit"]');
            const originalText = saveButton.textContent;
            saveButton.innerHTML = '<span class="loading"></span> Saving...';
            saveButton.disabled = true;
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(departmentData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Failed to save department'); });
                }
                return response.json();
            })
            .then(data => {
                console.log('Save response:', data);
                if (data.message) {
                    showToast(data.message);
                    document.getElementById('departmentModal').style.display = 'none';
                    document.getElementById('departmentForm').reset();
                    loadDepartments();
                    editingDepartment = null;
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast(error.message || 'Error saving department. Please try again.', true);
            })
            .finally(() => {
                // Restore button state
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            });
        }
        
        function deleteDepartment(departmentId) {
            if (confirm('Are you sure you want to delete this department? This action cannot be undone.')) {
                fetch(`/api/departments?id=${departmentId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Failed to delete department'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.message) {
                        showToast(data.message);
                        loadDepartments();
                    } else {
                        throw new Error(data.error || 'Unknown error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast(error.message || 'Error deleting department. Please try again.', true);
                });
            }
        }
    </script>
</body>
</html>
