async function saveBudget(budgetData) {
    try {
        console.log('Saving budget:', budgetData);
        
        const response = await fetch('/api/budget', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(budgetData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Budget updated successfully!');
            document.getElementById('budgetModal').style.display = 'none';
            
            // IMPORTANT: Force refresh dashboard data immediately
            await loadDashboardData();
            
            // Also update the budget display directly
            updateBudgetDisplayAfterSave(budgetData);
            
        } else {
            alert('Error updating budget: ' + result.error);
            console.error('Budget update error:', result.error);
        }
    } catch (error) {
        alert('Error updating budget. Please check the console for details.');
        console.error('Error saving budget:', error);
    }
}

function updateBudgetDisplayAfterSave(budgetData) {
    // Update the budget amounts immediately
    document.getElementById('totalBudget').textContent = `$${formatCurrency(budgetData.totalAllocated)}`;
    document.getElementById('waterBudget').textContent = `$${formatCurrency(budgetData.waterAllocated)}`;
    document.getElementById('electricityBudget').textContent = `$${formatCurrency(budgetData.electricityAllocated)}`;
    document.getElementById('telephoneBudget').textContent = `$${formatCurrency(budgetData.telephoneAllocated)}`;
    
    // Update progress bars based on current usage
    updateProgressBars();
}

function updateProgressBars() {
    // This function updates progress bars based on current data
    const totalAllocated = parseFloat(document.getElementById('totalBudget').textContent.replace('$', '').replace(/,/g, ''));
    const waterAllocated = parseFloat(document.getElementById('waterBudget').textContent.replace('$', '').replace(/,/g, ''));
    const electricityAllocated = parseFloat(document.getElementById('electricityBudget').textContent.replace('$', '').replace(/,/g, ''));
    const telephoneAllocated = parseFloat(document.getElementById('telephoneBudget').textContent.replace('$', '').replace(/,/g, ''));
    
    // Get current usage from the data (you may need to adjust this)
    const waterUsed = parseFloat(document.getElementById('waterUsed').textContent.replace('$', '').replace(/,/g, '')) || 0;
    const electricityUsed = parseFloat(document.getElementById('electricityUsed').textContent.replace('$', '').replace(/,/g, '')) || 0;
    const telephoneUsed = parseFloat(document.getElementById('telephoneUsed').textContent.replace('$', '').replace(/,/g, '')) || 0;
    const totalUsed = parseFloat(document.getElementById('totalUsed').textContent.replace('$', '').replace(/,/g, '')) || 0;
    
    // Calculate percentages
    const waterPercentage = Math.min(100, (waterUsed / waterAllocated) * 100);
    const electricityPercentage = Math.min(100, (electricityUsed / electricityAllocated) * 100);
    const telephonePercentage = Math.min(100, (telephoneUsed / telephoneAllocated) * 100);
    const totalPercentage = Math.min(100, (totalUsed / totalAllocated) * 100);
    
    // Update progress bars
    document.getElementById('totalProgressBar').style.width = `${totalPercentage}%`;
    document.getElementById('waterProgressBar').style.width = `${waterPercentage}%`;
    document.getElementById('electricityProgressBar').style.width = `${electricityPercentage}%`;
    document.getElementById('telephoneProgressBar').style.width = `${telephonePercentage}%`;
    
    // Update remaining amounts
    const waterRemaining = waterAllocated - waterUsed;
    const electricityRemaining = electricityAllocated - electricityUsed;
    const telephoneRemaining = telephoneAllocated - telephoneUsed;
    const totalRemaining = totalAllocated - totalUsed;
    
    document.getElementById('waterRemaining').textContent = `Remaining: $${formatCurrency(waterRemaining)}`;
    document.getElementById('electricityRemaining').textContent = `Remaining: $${formatCurrency(electricityRemaining)}`;
    document.getElementById('telephoneRemaining').textContent = `Remaining: $${formatCurrency(telephoneRemaining)}`;
    document.getElementById('totalRemaining').textContent = `Remaining: $${formatCurrency(totalRemaining)}`;
}
